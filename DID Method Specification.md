# DID method specification

Version: 0.1

CAUTION: THIS DOCUMENT IS REFERENCED IN W3C'S [DID METHOD REGISTRY][w3c-did-method-registry].

## Status of this document

The KILT blockchain will evolve: it will become permissionless and will transition from a testnet to a persistent testnet.
When such network evolutions happen, this specification will be updated and the version number will be bumped.

## 1. Method and Identifier

### 1.1. Method

The identifier for KILT Protocol's DID Method is `kilt`.
A KILT DID starts with `did:kilt:`.

It conforms with the [generic DID syntax][w3c-did-spec-syntax].

### 1.2. DID Method-specific identifier

The DID Method-specific identifier is an [ss58][ss58] public address, generated by encoding the **signing** public key of a KILT Identity.

## 2. DIDs in KILT

KILT DIDs are stored on KILT Protocol's blockchain that is public and by definition decentralized.
The KILT Blockchain runs in a proof-of-authority manner and will become permissionless, see `§ Status of this document` in this specification document.

KILT Blockchain nodes implement a DID module to create, store, query and manage DIDs in the form of on-chain **DID items**.
A DID item is a mapping between the DID owner's public address and its public signature key `sign_key`, its public encryption key `box_key`, and an optional location for the associated DID Document `doc_ref`:

`owner => (sign_key, box_key, doc_ref)`

## 3. Operations

### 3.1. Operation: Create a DID and a DID Document

#### 3.1.1. Create a DID

An `add` function can be used to store a DID item on the KILT Blockchain; this function takes the following parameters:

* `owner`: the public ss58 address of the caller of the method;
* `sign_key`: the public signing key of the owner (= KILT identity corresponding to this DID);
* `box_key`: the public encryption key of the owner (= KILT identity corresponding to this DID);
* `doc_ref`: optional reference to the storage location of a DID document; typically a URL.

The blockchain node verifies the transaction signature corresponding to the owner and inserts it to the blockchain storage by using a map:

```rust
owner => (sign_key, box_key, doc_ref)
```

Example of a DID item's contents before encoding and storage:

```rust
{
  "sign_key": "0xa6c8...c614",
  "box_key": "0xa5e6...d08b",
  "doc_ref": "0x2f2f...6258"
}
```

#### 3.1.2 Create (and optionally store) the associated DID Document

A DID Document can be either:

* (**Mode 1 = static**) Pregenerated and stored on a server;
  
  or
* (**Mode 2 = dynamic**) Dynamically generated on-demand.

Mode 2 is covered in `§3.2 Operation: Read/Resolve a DID to a DID Document` in this specification document.

Mode 1 works as follows:

The DID document corresponding to a DID item can be created by using the structure outlined below.
`<address>`, `<sign_key>` and `<box_key>` should be replaced by their respective values in the on-chain DID item.

DID Document:

```json
{
  "id": "did:kilt:<address>",
  "authentication": {
    "type": "Ed25519SignatureAuthentication2018",
    "publicKey": [
      "did:kilt:<address>#key-1"
    ]
  },
  "publicKey": [
    {
      "id": "did:kilt:<address>#key-1",
      "type": "Ed25519VerificationKey2018",
      "controller": "did:kilt:<address>",
      "publicKeyHex": <sign_key>
    },
    {
      "id": "did:kilt:<address>#key-2",
      "type": "X25519Salsa20Poly1305Key2018",
      "controller": "did:kilt:<address>",
      "publicKeyHex": <box_key>
    }
  ],
  "@context": "https://w3id.org/did/v1",
  "service": [
    {
      "type": "KiltMessagingService",
      "serviceEndpoint": "//services.kilt.io:443/messaging"
    }
  ]
}
```

Once created, the document shall be stored on the `doc_ref` specified at DID item creation (see `§3.1.1. Create a DID` in this specification document). Note that the KILT protocol does not enforce that the DID Document is actually stored and available at the specified `doc_ref`.

A signed hash of the DID Document can and should be appended to the stored data in order to prevent tampering. More on that in `§4. Security and Privacy considerations` in this specification document.

#### 3.1.3. Proving control

As stated in the [DID specification][w3c-did-spec-control], proving control of a DID means proving the **binding** between this DID and the DID Document that describes it. It is a two step process:

* Resolving the DID to a DID Document according to the KILT DID Method specification, as detailed in `§3.2 Operation: Read/Resolve a DID to a DID Document` in this specification document;
* Verifying that the `id` property of the resulting DID Document matches the DID that was resolved.

### 3.2. Operation: Read/Resolve a DID to a DID Document

* (Mode 1 = static) If the DID Document has been pregenerated and stored off-chain on a server i.e. if the DID item specifies a document storage location (`doc_ref`), the DID Document can be accessed as followed:

Query the KILT blockchain for the DID item => Get the DID Document's storage location from the DID item (doc_ref) => Fetch the DID Document at the specified location.

Once the chain query result is received, it should first be converted to JSON.
Decoding can be done as follows:

```
publicSigningKey: resultAsJSON[0]
publicBoxKey: resultAsJSON[1]
documentStore = hexadecimal to string of resultAsJSON[2]
```

Once the DID Document's storage location is determined, a standard HTTP/HTTPS fetch _may_ be used to retrieve the associated DID Document. Yet depending on the storage location type, other techniques might need to be used.

* (Mode 2 = dynamic) In this mode, a DID Document can be generated on-the-fly by a DID subject and sent to any requesting entity as needed. The DID Document can be generated from a KILT Identity or by using the template provided in `§3.1.2 Create (and optionally store) the associated DID Document` in this specification document.

### 3.3. Operation: Update the DID Document

If the DID Document has been pregenerated and stored off-chain on a server (Mode 1 = static), the DID Document can be updated on the specified storage.
It **must be ensured that the identity operating the update is authorized to do so**, e.g. by making use of the `authentication` property in the DID Document.

### 3.4. Operation: Deactivate

Deactivating a DID can be done by using the KILT blockchain's `remove` method on a DID.
This removes the document storage location property, effectively unlinking a DID from its DID Document.

## 4. Security and Privacy considerations

### 4.1. Private key

An identity that creates a DID item also effectively controls the associated DID Document.
Hence the private key for this identity should be kept entirely private.

### 4.2. DID Document tampering

If the DID Document has been pregenerated and stored off-chain on a server (Mode 1 = static), it is strongly encouraged to make use of a digital signature on the DID Document to prevent data tampering:

* The controller of the DID Document should send it, together with a signed hash, to the server;
* The server should verify this signature on create events and update events on the DID Document;
* Any consumer of the DID Document, such as an entity accessing the off-chain DID Document in order to establish a secure communication channel with the given DID Subject, should verify the signature as well.

### 4.3. Other security and privacy considerations

All security and privacy considerations described in the [w3c working draft][w3c-did-core] are relevant in the case of KILT DIDs, and must be taken into account by applications / system developers making use of KILT DIDs.


## 5. SDK

The [KILT SDK][sdk] is a convenient tool to interact with the KILT blockchain. There is no technical constraint to use the KILT SDK to use KILT DIDs.

The following table lists the methods available in the SDK to perform each DID-related operation.

| Operation   |      KILT SDK function   |
|----------|------|
| Create a DID | `fromIdentity` |
| Create a DID Document |  `createDefaultDidDocument` |
| Read/Resolve a DID to a DID Document | `queryByIdentifier`/`queryByAdress` and access `documentStore` (= `doc_ref`) in Mode 1 = static, or `createDefaultDidDocument` in Mode 2 = dynamic |
| Deactivate | `remove` |
| Sign a DID Document | `signDidDocument` |
| Verify the signature of a DID Document | `verifyDidDocumentSignature` |

[sdk]: https://github.com/KILTprotocol/sdk-js
[w3c-did-core]: https://w3c.github.io/did-core/
[w3c-did-spec-syntax]: https://w3c-ccg.github.io/did-spec/#generic-did-syntax
[w3c-did-spec-control]: https://w3c-ccg.github.io/did-spec/#proving-control-of-a-did-and-did-document
[w3c-did-method-registry]: https://w3c-ccg.github.io/did-method-registry/
[ss58]: https://github.com/paritytech/substrate/wiki/External-Address-Format-(SS58)
